name: CI-CD

on:
  push:
    branches:
      - "**"
    tags:
      - "release/*"

jobs:
  ci-web:
    if: github.ref_type == 'branch'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Emscripten
        uses: mymindstorm/setup-emsdk@v14
        with:
          version: 3.1.64

      - name: Configure web
        run: emcmake cmake -S . -B build-web

      - name: Build web
        run: cmake --build build-web --config Release

      - name: Package web artifact with index entry
        run: |
          mkdir -p dist
          cp build-web/raylib_dino_runner.html dist/index.html
          cp build-web/*.js dist/
          cp build-web/*.wasm dist/
          cp build-web/*.data dist/
          mkdir -p dist/assets/runtime
          cp -r assets/runtime/sprites dist/assets/runtime/
          cp -r assets/runtime/sfx dist/assets/runtime/

      - name: Upload web artifact
        uses: actions/upload-artifact@v4
        with:
          name: raylib-dino-web-${{ github.sha }}
          path: |
            dist/index.html
            dist/*.js
            dist/*.wasm
            dist/*.data
            dist/assets/runtime/sprites/*.png
            dist/assets/runtime/sfx/*.ogg

  deploy-s3:
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' || startsWith(github.ref, 'refs/tags/release/'))
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Emscripten
        uses: mymindstorm/setup-emsdk@v14
        with:
          version: 3.1.64

      - name: Configure web
        run: emcmake cmake -S . -B build-web

      - name: Build web
        run: cmake --build build-web --config Release

      - name: Package deploy bundle with index entry
        run: |
          mkdir -p dist
          cp build-web/raylib_dino_runner.html dist/index.html
          cp build-web/*.js dist/
          cp build-web/*.wasm dist/
          cp build-web/*.data dist/
          mkdir -p dist/assets/runtime
          cp -r assets/runtime/sprites dist/assets/runtime/
          cp -r assets/runtime/sfx dist/assets/runtime/

      - name: Resolve deploy version and path
        run: |
          repo_name="${GITHUB_REPOSITORY#*/}"
          if [[ "${GITHUB_REF_TYPE}" == "tag" && "${GITHUB_REF_NAME}" == release/* ]]; then
            version="${GITHUB_REF_NAME#release/}"
          else
            release_tag="$(git tag --points-at "$GITHUB_SHA" | grep '^release/' | head -n 1 || true)"
            if [[ -n "$release_tag" ]]; then
              version="${release_tag#release/}"
            else
              version="$(date -u +%F)-${GITHUB_SHA::7}"
            fi
          fi
          echo "REPO_NAME=${repo_name}" >> "$GITHUB_ENV"
          echo "VERSION=${version}" >> "$GITHUB_ENV"

      - name: Setup AWS CLI
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Sync versioned release to S3
        env:
          S3_BUCKET: ${{ secrets.S3_BUCKET }}
        run: |
          test -n "$S3_BUCKET"
          aws s3 sync dist/ "s3://$S3_BUCKET/$REPO_NAME/$VERSION/" --delete
